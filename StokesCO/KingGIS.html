<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Stokes County Parcels — King, NC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body, html { height:100%; margin:0; }
    #map { height:100%; width:100%; }
    .searchbar {
      position: absolute;
      top: 10px; left: 50px;
      z-index: 1000;
      background: white;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      font-family: Arial, sans-serif;
    }
    .searchbar input { width:240px; padding:6px; margin-right:6px; }
    .searchbar button { padding:6px 8px; }
  </style>
</head>
<body>
  <div class="searchbar">
    <input id="qtext" placeholder="Search Parcel Number or Owner (e.g. 123456 or SMITH)" />
    <button id="searchBtn">Search</button>
    <button id="resetBtn">Reset</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.4/dist/esri-leaflet.js"></script>

  <script>
  // --- Configuration: change if needed ---
  const PARCEL_LAYER_URL = 'https://stokescountygis.com/server/rest/services/Parcels/MapServer/0';
  // --- End configuration ---

  // create map and basemap
  const map = L.map('map').setView([36.4, -80.25], 11); // center roughly in Stokes County
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // make an Esri feature layer (fetches features on demand for visible extent)
  const parcelLayer = L.esri.featureLayer({
    url: PARCEL_LAYER_URL,
    simplifyFactor: 0.5,
    precision: 5,
    style: function () {
      return {
        color: '#2b7bba', // outlines
        weight: 1,
        fillOpacity: 0.05
      };
    }
  }).addTo(map);

  // Popup template - fields available (see Stokes Parcels layer fields). We'll show the most useful ones:
  function parcelPopupHtml(props) {
    // guard for missing fields
    const p = props || {};
    const owner = p.PROPERTY_OWNER_1 || 'Unknown owner';
    const addr = p.PHYSICAL_ADDRESS || [
      p.PHYS_ADDR_STREET_NUMBER || '', p.PHYS_ADDR_STREET_NAME || '', p.PHYS_ADDR_STREET_TYPE || ''
    ].join(' ').trim() || (p.PHYS_ADDR_CITY ? p.PHYS_ADDR_CITY : 'No physical address');
    const parcel = p.PARCEL_NUMBER || p.PIN || 'n/a';
    const acres = (p.CALCULATED_ACREAGE ?? p.ACREAGE ?? p.TOTAL_ACREAGE) || 'n/a';
    const value = p.TOTAL_PROPERTY_VALUE ? '$' + Number(p.TOTAL_PROPERTY_VALUE).toLocaleString() : 'n/a';
    const deedDate = p.DEED_DATE ? new Date(p.DEED_DATE).toLocaleDateString() : 'n/a';

    return `
      <div style="font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:1.25">
        <strong>${owner}</strong><br/>
        <small>${addr}</small><br/><hr style="margin:6px 0"/>
        <b>Parcel:</b> ${parcel}<br/>
        <b>Acreage:</b> ${acres}<br/>
        <b>Assessed value:</b> ${value}<br/>
        <b>Deed date:</b> ${deedDate}
      </div>
    `;
  }

  // open popup on feature click
  parcelLayer.on('click', function(evt) {
    const props = evt.layer.properties || evt.layer.feature && evt.layer.feature.properties;
    const html = parcelPopupHtml(props);
    L.popup({maxWidth:360}).setLatLng(evt.latlng).setContent(html).openOn(map);
  });

  // when layer loads for the first time, fit to its bounds (optional)
  parcelLayer.on('load', function() {
    // don't auto-zoom on every tile load; this only runs when initial metadata is ready
    // to avoid overwhelming view, we do not fetch all features here
  });

  // Utility: run a server-side query and show results (supports owner or parcel number searches)
  async function runSearch(q) {
    if (!q || q.trim().length === 0) return;
    const clean = q.trim().replace(/'/g,"''"); // escape single quotes for SQL
    // Build a where clause that looks for exact parcel number OR owner name contains
    // NOTE: field names come from Stokes Parcels layer (PROPERTY_OWNER_1, PARCEL_NUMBER, PIN, etc.)
    // We'll search parcel-number style as exact match OR owner/or partial match (ILIKE isn't supported, so use LIKE)
    const where = `(UPPER(PARCEL_NUMBER) = UPPER('${clean}') OR UPPER(PIN) = UPPER('${clean}') OR UPPER(PROPERTY_OWNER_1) LIKE UPPER('%${clean}%') OR UPPER(PROPERTY_OWNER_2) LIKE UPPER('%${clean}%'))`;

    // Query endpoint that returns geojson (will respect server maxRecordCount, so we limit to first 5000)
    const queryUrl = PARCEL_LAYER_URL + '/query?where=' + encodeURIComponent(where) +
                     '&outFields=*' +
                     '&f=geojson' +
                     '&returnGeometry=true' +
                     '&resultRecordCount=5000';

    try {
      const resp = await fetch(queryUrl);
      if (!resp.ok) throw new Error('Server returned ' + resp.status);
      const geojson = await resp.json();
      if (!geojson || !geojson.features || geojson.features.length === 0) {
        alert('No parcels found for "' + q + '". Try a different parcel number or owner name.');
        return;
      }
      // Remove any previous results layer
      if (window.searchResultsLayer) {
        map.removeLayer(window.searchResultsLayer);
      }
      // show results with a highlighted style
      window.searchResultsLayer = L.geoJSON(geojson, {
        style: function() { return {color:'#ff7800', weight:2, fillOpacity:0.12}; },
        onEachFeature: function(feature, layer) {
          layer.bindPopup(parcelPopupHtml(feature.properties));
        }
      }).addTo(map);
      // fit map to result bounds
      map.fitBounds(window.searchResultsLayer.getBounds(), {padding:[20,20]});
    } catch (err) {
      console.error(err);
      alert('Search failed: ' + err.message + '. If CORS or network errors occur, try hosting this file on a small web server (see instructions).');
    }
  }

  // UI handlers
  document.getElementById('searchBtn').addEventListener('click', function() {
    const q = document.getElementById('qtext').value;
    runSearch(q);
  });
  document.getElementById('qtext').addEventListener('keyup', function(e){
    if (e.key === 'Enter') runSearch(this.value);
  });
  document.getElementById('resetBtn').addEventListener('click', function(){
    document.getElementById('qtext').value = '';
    if (window.searchResultsLayer) { map.removeLayer(window.searchResultsLayer); window.searchResultsLayer = null; }
    // optionally zoom back to county extent:
    // map.setView([36.4, -80.25], 11);
  });

  // Helpful note: If you want parcel labels (parcel number) only when zoomed in, you can add logic that queries parcel attribute(s)
  // for the visible bbox and draws small labels. Esri-Leaflet's featureLayer already requests features for the current view as you pan/zoom.
  </script>
</body>
</html>
