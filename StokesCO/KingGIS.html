<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Parcels in King, NC — Stokes County</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body, html { height:100%; margin:0; padding:0; }
    #map { position: absolute; top:0; bottom:0; width:100%; }
    .control-panel {
      position: absolute;
      top: 10px;
      left: 50px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 10px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      font-family: “Segoe UI”, Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
    }
    .control-panel input {
      padding: 6px;
      font-size: 14px;
      width: 200px;
      margin-right: 6px;
    }
    .control-panel button {
      padding: 6px 10px;
      font-size: 14px;
      margin-right: 4px;
    }
    .leaflet-control-attribution { font-size: 11px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="control-panel">
    <input id="qtext" placeholder="Parcel Number (e.g. 12345)" />
    <button id="searchBtn">Lookup</button>
    <button id="resetBtn">Show All in King</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.4/dist/esri-leaflet.js"></script>
  <script>
  // ============ Configuration ================
  const PARCEL_LAYER_URL = 'https://stokescountygis.com/server/rest/services/Parcels/MapServer/0';
  const KING_FIELD = 'MUNICIPALITY';        // field name that holds town name / municipality
  const KING_VALUE = 'King';               // the value identifying King, NC in that field
  const PARCEL_NUMBER_FIELD = 'PARCEL_NUMBER'; // field for parcel number
  const OWNER_FIELD = 'PROPERTY_OWNER_1';
  const ADDRESS_FIELD = 'PHYSICAL_ADDRESS'; // or a combination of address fields if needed
  const ACREAGE_FIELD = 'CALCULATED_ACREAGE';
  const VALUE_FIELD = 'TOTAL_PROPERTY_VALUE';
  const DEED_FIELD = 'DEED_DATE';
  // ============================================

  const map = L.map('map').setView([36.4, -80.25], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // Feature layer filtered to only King parcels
  const parcelLayer = L.esri.featureLayer({
    url: PARCEL_LAYER_URL,
    where: `${KING_FIELD} = '${KING_VALUE}'`,
    simplifyFactor: 0.4,
    precision: 5,
    style: function(feature) {
      return {
        color: '#005a8d',
        weight: 1.5,
        fillOpacity: 0.15,
        fillColor: '#4da6ff'
      };
    },
    pointToLayer: null, // polygons only
    onEachFeature: function(feature, layer) {
      layer.on('click', function(e) {
        const html = popupHtml(feature.properties);
        layer.bindPopup(html, {maxWidth: 300}).openPopup();
      });
    }
  }).addTo(map);

  // Popup HTML
  function popupHtml(p) {
    const owner = p[OWNER_FIELD] || 'Unknown Owner';
    // for address, some services may have PHYSICAL_ADDRESS, else combination
    const addr = p[ADDRESS_FIELD] ||
                 [p.PHYS_ADDR_STREET_NUMBER, p.PHYS_ADDR_STREET_NAME, p.PHYS_ADDR_STREET_TYPE]
                    .filter(x => x).join(' ') ||
                 'No address';
    const pin = p[PARCEL_NUMBER_FIELD] || 'n/a';
    const acres = p[ACREAGE_FIELD] !== undefined ? p[ACREAGE_FIELD].toFixed(2) : 'n/a';
    const val = p[VALUE_FIELD] ? '$' + Number(p[VALUE_FIELD]).toLocaleString() : 'n/a';
    const deed = p[DEED_FIELD] ? new Date(p[DEED_FIELD]).toLocaleDateString() : 'n/a';

    return `
      <div style="font-family:Arial, sans-serif; font-size:13px;">
        <strong>${owner}</strong><br/>
        <em>${addr}</em><br/><hr style="margin:6px 0"/>
        <b>Parcel #:</b> ${pin}<br/>
        <b>Acreage:</b> ${acres}<br/>
        <b>Value:</b> ${val}<br/>
        <b>Deed date:</b> ${deed}
      </div>
    `;
  }

  // After loading, fit to King bounds
  parcelLayer.on('load', function() {
    // optionally zoom to all King parcels
    map.fitBounds(parcelLayer.getBounds(), {padding: [20,20]});
  });

  // ---- Search / lookup by parcel number ----
  async function lookupParcel(parcelNum) {
    const clean = parcelNum.trim().replace(/'/g, "''");
    if (!clean) {
      alert('Enter a parcel number.');
      return;
    }
    // Query only within King
    const where = `${KING_FIELD} = '${KING_VALUE}' AND UPPER(${PARCEL_NUMBER_FIELD}) = UPPER('${clean}')`;
    const queryUrl = PARCEL_LAYER_URL + '/query?' +
      'where=' + encodeURIComponent(where) +
      '&outFields=*&returnGeometry=true&f=geojson';

    try {
      const resp = await fetch(queryUrl);
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const geojson = await resp.json();
      if (!geojson.features || geojson.features.length === 0) {
        alert('Parcel not found in King: ' + clean);
        return;
      }
      // remove previous search highlight
      if (window.searchLayer) {
        map.removeLayer(window.searchLayer);
      }
      window.searchLayer = L.geoJSON(geojson, {
        style: {
          color: '#ff0000',
          weight: 2,
          fillOpacity: 0.2,
          fillColor: '#ff6666'
        },
        onEachFeature: function(feat, lay) {
          lay.bindPopup(popupHtml(feat.properties), {maxWidth:300});
        }
      }).addTo(map);
      map.fitBounds(window.searchLayer.getBounds(), {padding:[20,20]});
    } catch (err) {
      console.error('Lookup error', err);
      alert('Lookup failed: ' + err.message);
    }
  }

  document.getElementById('searchBtn').addEventListener('click', () => {
    const q = document.getElementById('qtext').value;
    lookupParcel(q);
  });
  document.getElementById('qtext').addEventListener('keyup', e => {
    if (e.key === 'Enter') lookupParcel(e.target.value);
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    // Remove search highlight
    if (window.searchLayer) {
      map.removeLayer(window.searchLayer);
    }
    // Zoom back to King parcels
    map.fitBounds(parcelLayer.getBounds(), {padding:[20,20]});
  });
  </script>
</body>
</html>
